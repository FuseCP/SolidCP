<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <RootNamespace>SolidCP.WebPortal</RootNamespace>
        <AssemblyName>SolidCP.WebPortal</AssemblyName>
        <TargetFrameworks>net8.0</TargetFrameworks>
        <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
        <AppendRuntimeIdentifierToOutputPath>false</AppendRuntimeIdentifierToOutputPath>
        <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
        <RestoreSources>$(RestoreSources);../../Lib/WebFormsForCore/nupkg;https://api.nuget.org/v3/index.json</RestoreSources>
        <CopyDebugSymbolFilesFromPackages>true</CopyDebugSymbolFilesFromPackages>
    </PropertyGroup>
    <PropertyGroup Condition="$(TargetFramework) == 'net48'">
        <OutputPath>bin\</OutputPath>
        <OutputType>Library</OutputType>
    </PropertyGroup>
    <PropertyGroup Condition="$(TargetFramework) != 'net48'">
        <OutputPath>bin_dotnet\</OutputPath>
        <OutputType>Exe</OutputType>
    </PropertyGroup>
    <PropertyGroup>
        <AspNetCompiler>$(WINDIR)\Microsoft.NET\Framework\v4.0.30319\aspnet_compiler.exe</AspNetCompiler>
        <DeployDir>..\..\Build\$(Configuration)\Portal</DeployDir>
    </PropertyGroup>
    <PropertyGroup>
        <IncludeSetAclProviderOnDestination>False</IncludeSetAclProviderOnDestination>
        <ExcludeFilesFromPackage>True</ExcludeFilesFromPackage>
        <CopyAllFilesToSingleFolderForPackageDependsOn>
            PreDeploySolidCPProjectBinaries;
            $(CopyAllFilesToSingleFolderForPackageDependsOn);
        </CopyAllFilesToSingleFolderForPackageDependsOn>
    </PropertyGroup>
    <Target Name="MoveDllsToBinLazy" AfterTargets="Build">
        <Message Text="Move dll files to bin\Lazy" Importance="high" />
        <ItemGroup>
            <FilesToMove Include="bin\AdvancedStringBuilder.*" />
            <!--<FilesToMove Include="bin\AntiXssLibrary.*" />-->
            <FilesToMove Include="bin\Antlr3.Runtime.*" />
            <FilesToMove Include="bin\Newtonsoft.Json.*" />
            <FilesToMove Include="bin\BundleTransformer.Core.*" />
            <FilesToMove Include="bin\BundleTransformer.Less.*" />
            <FilesToMove Include="bin\CPCC.*" />
            <FilesToMove Include="bin\JavaScriptEngineSwitcher.Core.*" />
            <FilesToMove Include="bin\JavaScriptEngineSwitcher.Msie.*" />
            <FilesToMove Include="bin\Microsoft.ReportViewer.Common.*" />
            <FilesToMove Include="bin\Microsoft.ReportViewer.ProcessingObjectModel.*" />
            <FilesToMove Include="bin\Microsoft.ReportViewer.WebForms.*" />
            <FilesToMove Include="bin\Microsoft.Win32.Registry.*" />
            <FilesToMove Include="bin\MsieJavaScriptEngine.*" />
            <FilesToMove Include="bin\SolidCP.Providers.Base.*" />
            <FilesToMove Include="bin\System.Security.AccessControl.*" />
            <FilesToMove Include="bin\System.Security.Principal.Windows.*" />
            <FilesToMove Include="bin\System.Web.Optimization.*" />
            <FilesToMove Include="bin\WebGrease.*" />
            <FilesToMove Include="bin\Microsoft.Data.Sqlite.*" />
            <FilesToMove Include="bin\.*" />
        </ItemGroup>
        <Move SourceFiles="@(FilesToMove)" DestinationFolder="bin\Lazy" />
        <!--<Message Text="Restore needed dlls from bin\Lazy to bin" Importance="high" />
    <ItemGroup>
      <FilesNeededInBin Include="bin\Lazy\SolidCP.Portal.Modules.*" />
      <FilesNeededInBin Include="bin\Lazy\SolidCP.Portal.Modules.dll.config" />
    </ItemGroup>
    <Move SourceFiles="@(FilesNeededInBin)" DestinationFolder="bin" />-->
    </Target>
    <Target Name="PreDeploySolidCPProjectBinaries">
        <ItemGroup>
            <_CustomFiles Include="$(TargetDir)\SolidCP.*" />
            <FilesForPackagingFromProject Include="@(_CustomFiles)">
                <DestinationRelativePath>bin\%(Filename)%(Extension)</DestinationRelativePath>
            </FilesForPackagingFromProject>
        </ItemGroup>
    </Target>
    <Target Name="DeleteConfigObjFiles">
        <ItemGroup>
            <ConfigObjFiles Include="obj/**/*.config" />
        </ItemGroup>
        <Delete Files="@(ConfigIObjFiles)" />
    </Target>
    <Target Name="Precompile" DependsOnTargets="DeleteConfigObjFiles">
        <Exec Command="$(AspNetCompiler) -p . -v /" />
    </Target>
    <Target Name="DeployWithPrecompile" DependsOnTargets="DeleteConfigObjFiles">
        <Message Text="Precompile WebPortal" Importance="high" />
        <AspNetCompiler PhysicalPath="." VirtualPath="/" TargetPath="$(DeployDir)" Force="true" />
        <ItemGroup>
            <AppDlls Include="$(DeployDir)\bin\App_*.dll" Exclude="$(DeployDir)\bin\App_global.asax.dll;$(DeployDir)\bin\App_Browsers.dll;$(DeployDir)\bin\App_GlobalResources.dll;$(DeployDir)\bin\App_Theme_Default.dll" />
        </ItemGroup>
        <Move SourceFiles="@(AppDlls)" DestinationFolder="$(DeployDir)\bin\Lazy" />
        <!-- Create App_GlobalResources.list file, because there is no App_GlobalResources folder anymore -->
        <Exec Command="powershell &quot;Get-ChildItem App_GlobalResources -recurse -include *.resx | ForEach-Object { $_.Name } &gt; $(DeployDir)\App_Data\App_GlobalResources.list&quot;" />
        <!-- Correct ExternalProbingPaths in web.config -->
        <Exec Command="powershell &quot;(Get-Content Web.config) -replace '\.\.\\SolidCP.EnterpriseServer', '..\EnterpriseServer' | Set-Content -Path $(DeployDir)\Web.config&quot;" />
    </Target>
    <ItemGroup>
        <PackageReference Include="AdvancedStringBuilder" Version="0.1.1" />
        <PackageReference Include="Antlr" Version="3.5.0.2" />
        <PackageReference Include="BundleTransformer.Core" Version="1.14.1" />
        <PackageReference Include="BundleTransformer.Less" Version="1.14.0" />
        <PackageReference Include="JavaScriptEngineSwitcher.Core" Version="3.24.1" />
        <PackageReference Include="JavaScriptEngineSwitcher.Msie" Version="3.19.0" />
        <PackageReference Include="MsieJavaScriptEngine" Version="3.0.9" />
        <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
    </ItemGroup>
    <ItemGroup Condition="'$(TargetFramework)' == 'net48'">
        <PackageReference Include="Microsoft.AspNet.Web.Optimization" Version="1.1.3" />
        <PackageReference Include="Microsoft.Web.Infrastructure" Version="2.0.0" />
        <PackageReference Include="WebGrease" Version="1.6.0" />
    </ItemGroup>
    <ItemGroup Condition="$(TargetFramework) != 'net48'">
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web" Version="1.1.1-beta" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Compilers" Version="1.1.1-beta" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Extensions" Version="1.1.1-beta" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Optimization" Version="1.1.1-beta" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Optimization.WebForms" Version="1.1.1-beta" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Infrastructure" Version="1.1.1-beta" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.WebGrease" Version="1.1.1-beta" />
    </ItemGroup>
    <ItemGroup>
        <Reference Include="AjaxControlToolkit, Version=3.5.40412.0, Culture=neutral, PublicKeyToken=28f01b0e84b6d53e, processorArchitecture=MSIL">
            <HintPath>..\..\Lib\AjaxControlToolkit.dll</HintPath>
            <SpecificVersion>False</SpecificVersion>
        </Reference>
        <Reference Include="AntiXssLibrary, Version=1.5.0.0, Culture=neutral, PublicKeyToken=5906d2bb3d8a12c4, processorArchitecture=MSIL">
            <HintPath>..\..\Lib\AntiXssLibrary.dll</HintPath>
            <SpecificVersion>False</SpecificVersion>
        </Reference>
        <Reference Include="Microsoft.ReportViewer.Common, Version=8.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a, processorArchitecture=MSIL">
            <HintPath>..\..\Lib\Microsoft.ReportViewer.Common.dll</HintPath>
            <Private>True</Private>
            <SpecificVersion>False</SpecificVersion>
        </Reference>
        <Reference Include="Microsoft.ReportViewer.ProcessingObjectModel, Version=8.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a, processorArchitecture=MSIL">
            <HintPath>..\..\Lib\Microsoft.ReportViewer.ProcessingObjectModel.dll</HintPath>
            <Private>True</Private>
            <SpecificVersion>False</SpecificVersion>
        </Reference>
        <Reference Include="Microsoft.ReportViewer.WebForms, Version=8.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a, processorArchitecture=MSIL">
            <HintPath>..\..\Lib\Microsoft.ReportViewer.WebForms.dll</HintPath>
            <Private>True</Private>
            <SpecificVersion>False</SpecificVersion>
        </Reference>
        <!--<Reference Include="System.Web" />
        <Reference Include="System.Web.ApplicationServices" />
        <Reference Include="System.Web.Extensions" />
        <Reference Include="System.Configuration" />-->
    </ItemGroup>
    <ItemGroup>
        <Content Include="tinymce\**\*.*" />
        <Content Include="App_Themes\**\*.*" />
        <Content Include="novnc\**\*.*" />
        <Content Include="JavaScript\**\*.*" />
        <Content Include="Styles\**\*.*" />
        <Content Include="**\*.png" Exclude="DesktopModules\**\*.png" />
        <Content Include="**\*.ico" Exclude="DesktopModules\**\*.ico" />
        <Content Include="**\*.svc" Exclude="DesktopModules\**\*.svc" />
        <Content Include="**\*.ascx" Exclude="DesktopModules\**\*.ascx" />
        <Content Include="**\*.ashx" Exclude="DesktopModules\**\*.ashx" />
        <Content Include="App_GlobalResources\*.resx">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="browserconfig.xml" />
        <Content Include="bin\AjaxControlToolkit.dll" />
        <Content Include="bin\AntiXssLibrary.dll" />
        <Content Include="bin\Microsoft.ReportViewer.Common.dll" />
        <Content Include="bin\Microsoft.ReportViewer.ProcessingObjectModel.dll" />
        <Content Include="bin\Microsoft.ReportViewer.WebForms.dll" />
        <Content Include="bin\Microsoft.Web.Services3.dll" />
        <Content Include="bin\SolidCP.Portal.Ecommerce.Modules.dll" />
        <Content Include="bin\SolidCP.Portal.Ecommerce.Modules.pdb" />
        <Content Include="bin\SolidCP.Portal.Modules.dll" />
        <Content Include="bin\SolidCP.Portal.Modules.pdb" />
        <Content Include="bin\SolidCP.Providers.Base.dll" />
        <Content Include="bin\SolidCP.Providers.Base.pdb" />
        <Content Include="bin\SolidCP.WebPortal.dll" />
        <Content Include="bin\SolidCP.WebPortal.pdb" />
        <Content Include="Error.htm" />
    </ItemGroup>
    <ItemGroup>
        <Compile Include="..\VersionInfo.cs" Link="Code\VersionInfo.cs" />
        <Compile Update="Code\WebPortalControlBase.cs">
            <SubType>ASPXCodeBehind</SubType>
        </Compile>
        <Compile Update="Code\PortalControlBase.cs">
            <SubType>ASPXCodeBehind</SubType>
        </Compile>
        <Compile Update="Default.aspx.cs">
            <SubType>ASPXCodeBehind</SubType>
            <DependentUpon>Default.aspx</DependentUpon>
        </Compile>
        <Compile Update="Default.aspx.designer.cs">
            <DependentUpon>Default.aspx</DependentUpon>
        </Compile>
        <Compile Update="Global.asax.cs">
            <DependentUpon>Global.asax</DependentUpon>
        </Compile>
    </ItemGroup>
    <ItemGroup>
        <Content Include="Global.asax" />
    </ItemGroup>
    <ItemGroup>
        <Content Include="Default.aspx" />
        <Content Include="SolidCP.WebPortal.deps.json">
          <CopyToOutputDirectory>Always</CopyToOutputDirectory>
        </Content>
        <Content Include="Web6.config">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="Web.config">
            <SubType>Designer</SubType>
        </Content>
    </ItemGroup>
    <ItemGroup>
        <Content Include="App_Browsers\CSSFriendlyAdapters.browser" />
        <Content Include="App_Data\ModulesData.config">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="App_Data\SiteSettings.config">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="App_Data\ESModule_ControlsHierarchy.config">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="bin\SolidCP.Portal.Ecommerce.Modules.dll.config" />
        <Content Include="bin\SolidCP.Portal.Modules.dll.config" />
        <Content Include="bin\SolidCP.WebPortal.dll.config" />
        <Content Include="manifest.json" />
        <None Include="compilerconfig.json" />
        <None Include="compilerconfig.json.defaults">
            <DependentUpon>compilerconfig.json</DependentUpon>
        </None>
        <None Include="Properties\PublishProfiles\Default Settings.pubxml" />
        <EmbeddedResource Include="Code\Adapters\empty.gif" />
    </ItemGroup>
    <ItemGroup>
        <!--<ProjectReference Include="..\..\Lib\WebFormsForCore\src\WebFormsForCore.Web\WebFormsForCore.Web.csproj" />-->
        <ProjectReference Include="..\CPCC\CPCC.csproj" />
        <ProjectReference Include="..\SolidCP.EnterpriseServer.Base\SolidCP.EnterpriseServer.Base.csproj" />
        <ProjectReference Include="..\SolidCP.EnterpriseServer\WebServices\SolidCP.Build\SolidCP.EnterpriseServer.Client.csproj" />
        <ProjectReference Include="..\SolidCP.Providers.Base\SolidCP.Providers.Base.csproj" />
        <ProjectReference Include="..\SolidCP.Web.Clients\SolidCP.Web.Clients.csproj" />
    </ItemGroup>
    <ItemGroup>
        <Compile Remove="DesktopModules\**\*.cs" />
    </ItemGroup>
    <ItemGroup>
      <None Remove="SolidCP.WebPortal.deps.json" />
    </ItemGroup>
    <ItemGroup>
      <Compile Include="DesktopModules\SolidCP\Code\Framework\ES.cs" />
    </ItemGroup>

    <Target Name="ChangeAliasesOfNugetRefs" Condition="$(TargetFramework) != 'net48'" BeforeTargets="FindReferenceAssembliesForReferences;ResolveReferences">
        <ItemGroup>
            <!-- Do not import System.Configuration.ConfigurationManager version 8 -->
            <ReferencePath Remove="%(Identity)" Condition="'%(FileName)' == 'System.Configuration.ConfigurationManager' AND $([System.Text.RegularExpressions.Regex]::IsMatch(%(Identity),'\\8.0.0\\'))" />
            <!-- Do not import System.Web -->
            <ReferencePath Remove="%(Identity)" Condition="'%(FileName)' == 'System.Web' AND $([System.Text.RegularExpressions.Regex]::IsMatch(%(Identity),'\\dotnet\\'))" />
        </ItemGroup>
    </Target>

</Project>