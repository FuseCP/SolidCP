<Project Sdk="Microsoft.NET.Sdk.Web">
    <PropertyGroup>
        <RootNamespace>SolidCP.WebPortal</RootNamespace>
        <AssemblyName>SolidCP.WebPortal</AssemblyName>
        <TargetFrameworks>net8.0;net48</TargetFrameworks>
        <LangVersion>13</LangVersion>
        <Nullable>disable</Nullable>
        <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
        <EnableDefaultContentItems>false</EnableDefaultContentItems>
        <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
        <AppendRuntimeIdentifierToOutputPath>false</AppendRuntimeIdentifierToOutputPath>
        <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
        <RestoreSources>$(RestoreSources);../../Lib/WebFormsForCore/nupkg;https://api.nuget.org/v3/index.json</RestoreSources>
        <IntermediateOutputPath>$(BaseIntermediateOutputPath)$(Configuration)\$(TargetFramework.ToLowerInvariant())\</IntermediateOutputPath>
        <GenerateRuntimeConfigurationFiles>true</GenerateRuntimeConfigurationFiles>
        <CopyDebugSymbolFilesFromPackages>true</CopyDebugSymbolFilesFromPackages>
        <GenerateDependencyFile>true</GenerateDependencyFile> 
        <EnableDynamicLoading>true</EnableDynamicLoading>
    </PropertyGroup>
    <PropertyGroup Condition="$(TargetFramework) == 'net48'">
        <OutputPath>bin\</OutputPath>
        <OutputType>Library</OutputType>
    </PropertyGroup>
    <PropertyGroup Condition="$(TargetFramework) != 'net48'">
        <OutputPath>bin_dotnet\</OutputPath>
        <OutputType>Exe</OutputType>
    </PropertyGroup>
    <PropertyGroup>
        <AspNetCompiler>$(WINDIR)\Microsoft.NET\Framework\v4.0.30319\aspnet_compiler.exe</AspNetCompiler>
        <DeployDir>..\..\Build\$(Configuration)\Portal</DeployDir>
    </PropertyGroup>
    <Target Name="DeleteConfigObjFiles">
        <ItemGroup>
            <ConfigObjFiles Include="obj/**/*.config" />
        </ItemGroup>
        <Delete Files="@(ConfigIObjFiles)" />
    </Target>
    <Target Name="Precompile" DependsOnTargets="DeleteConfigObjFiles">
        <Exec Command="$(AspNetCompiler) -p . -v /" />
    </Target>
    <Target Name="DeployWithPrecompile" DependsOnTargets="DeleteConfigObjFiles" Condition="$(OS) == 'Windows_NT'">
        <Message Text="Precompile WebPortal" Importance="high" />
        <PropertyGroup>
            <WindowsDir>$(WINDIR)</WindowsDir>
            <WindowsDir Condition="!Exists('$(WindowsDir)')">C:\Windows</WindowsDir>
            <AspNetCompiler>$(WindowsDir)\Microsoft.NET\Framework\v4.0.30319\aspnet_compiler.exe</AspNetCompiler>
            <AspNetCompiler Condition="!Exists('$(AspNetCompiler)')">$(WindowsDir)\Microsoft.NET\Framework64\v4.0.30319\aspnet_compiler.exe</AspNetCompiler>
        </PropertyGroup>
        <Message Text="$(AspNetCompiler)" Importance="high" />

        <AspNetCompiler PhysicalPath="." VirtualPath="/" TargetPath="$(DeployDir)" Force="true" Condition="$(MSBuildRuntimeType) == 'Full'" />
        <Exec Command="$(AspNetCompiler) -v / -p . -f $(DeployDir)" Condition="$(MSBuildRuntimeType) == 'Core'" />        
        
        <ItemGroup>
            <AppDlls Include="$(DeployDir)\bin\App_*.dll" Exclude="$(DeployDir)\bin\App_global.asax.dll;$(DeployDir)\bin\App_Browsers.dll;$(DeployDir)\bin\App_GlobalResources.dll;$(DeployDir)\bin\App_Theme_Default.dll" />
        </ItemGroup>
        <Move SourceFiles="@(AppDlls)" DestinationFolder="$(DeployDir)\bin\Lazy" />
        <!-- Create App_GlobalResources.list file, because there is no App_GlobalResources folder anymore -->
        <Exec Command="powershell &quot;Get-ChildItem App_GlobalResources -recurse -include *.resx | ForEach-Object { $_.Name } &gt; $(DeployDir)\App_Data\App_GlobalResources.list&quot;" />
        <!-- Correct ExternalProbingPaths in web.config -->
        <Exec Command="powershell &quot;(Get-Content Web.config) -replace '\.\.\\SolidCP.EnterpriseServer', '..\EnterpriseServer' | Set-Content -Path $(DeployDir)\Web.config&quot;" />
    </Target>
    <ItemGroup>
        <PackageReference Include="AdvancedStringBuilder" Version="0.1.1" />
        <PackageReference Include="Antlr" Version="3.5.0.2" />
        <PackageReference Include="BundleTransformer.Core" Version="1.14.1" />
        <PackageReference Include="BundleTransformer.Less" Version="1.14.0" />
        <PackageReference Include="JavaScriptEngineSwitcher.Core" Version="3.24.1" />
        <PackageReference Include="JavaScriptEngineSwitcher.Msie" Version="3.24.1" />
        <PackageReference Include="MsieJavaScriptEngine" Version="3.2.5" />
        <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
        <PackageReference Include="AntiXSS" Version="4.3.0" />
        <PackageReference Include="System.Buffers" Version="4.6.1" />
        <PackageReference Include="System.Memory" Version="4.6.3" />
        <PackageReference Include="MailKit" Version="4.11.0" />
        <PackageReference Include="MimeKit" Version="4.11.0" />
    </ItemGroup>
    <ItemGroup Condition="$(TargetFramework) == 'net48'">
        <PackageReference Include="Microsoft.AspNet.Web.Optimization" Version="1.1.3" />
        <PackageReference Include="Microsoft.Web.Infrastructure" Version="2.0.0" />
        <PackageReference Include="WebGrease" Version="1.6.0" />
        <PackageReference Include="AjaxControlToolkit" Version="20.1" />
        <Reference Include="System" />
        <Reference Include="System.Configuration" />
        <Reference Include="System.Drawing" />
        <Reference Include="System.EnterpriseServices" />
        <Reference Include="System.Data" />
        <Reference Include="System.Net.Http" />
        <Reference Include="System.Web" />
        <Reference Include="System.Web.ApplicationServices" />
        <Reference Include="System.Web.DynamicData" />
        <Reference Include="System.Web.Entity" />
        <Reference Include="System.Web.Mobile" />
        <Reference Include="System.Web.Extensions" />
        <Reference Include="System.Web.Optimization" />
        <Reference Include="System.Xml" />
    </ItemGroup>
    <ItemGroup Condition="$(TargetFramework) == 'net8.0'">
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Configuration" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Build" Version="1.3.1" ExcludeAssets="runtime" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Compilers" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Extensions" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Mobile" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Optimization" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Optimization.WebForms" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.Web.Infrastructure" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.WebGrease" Version="1.3.1" />
        <PackageReference Include="EstrellasDeEsperanza.WebFormsForCore.AjaxControlToolkit" Version="1.3.1" />
        <PackageReference Include="Microsoft.Data.SqlClient" Version="6.0.1" />
        
        <!-- .NET 8 for SolidCP.EnterpriseServer.Data -->
        <PackageReference Include="Microsoft.Extensions.Options" Version="9.0.4" />
        <PackageReference Include="Microsoft.Extensions.Primitives" Version="9.0.4" />
        <PackageReference Include="Microsoft.Extensions.Caching.Memory" Version="9.0.4" />
        <PackageReference Include="Microsoft.Extensions.DependencyInjection.Abstractions" Version="9.0.4" />
        <PackageReference Include="System.Text.Json" Version="9.0.4" />
        <PackageReference Include="System.Formats.Asn1" Version="9.0.4" />
        <PackageReference Include="Microsoft.Extensions.Configuration.Abstractions" Version="9.0.4" />
        <PackageReference Include="Microsoft.Extensions.Logging" Version="9.0.4" />
        <PackageReference Include="Microsoft.Extensions.DependencyModel" Version="9.0.4" />
    </ItemGroup>
    <ItemGroup>
        <Content Include="tinymce\**\*.*" />
        <Content Include="App_Themes\**\*.*" />
        <Content Include="novnc\**\*.*" />
        <Content Include="JavaScript\**\*.*" />
        <Content Include="Styles\**\*.*" />
        <Content Include="**\*.png" Exclude="DesktopModules\**\*.png" />
        <Content Include="**\*.ico" Exclude="DesktopModules\**\*.ico" />
        <Content Include="**\*.svc" Exclude="DesktopModules\**\*.svc" />
        <Content Include="**\*.ascx" Exclude="DesktopModules\**\*.ascx" />
        <Content Include="**\*.ashx" Exclude="DesktopModules\**\*.ashx" />
        <None Remove="DesktopModules\**\*.*" />
        <EmbeddedResource Remove="DesktopModules\**\*.resx" />
        <EmbeddedResource Remove="Properties\PublishProfiles\**" />
        <Compile Include="Code\**\*.cs" />
    </ItemGroup>

    <ItemGroup>
        <Content Include="App_GlobalResources\*.resx">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="appsettings.json">
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </Content>
        <Content Include="browserconfig.xml" />
        <Content Include="Error.htm" />
    </ItemGroup>
    <ItemGroup>
        <Compile Remove="DesktopModules\**\*.cs" />
        <Compile Remove="obj\**\*.cs" />
        <Compile Include="*.cs" />
        <Compile Include="..\VersionInfo.cs" Link="Code\VersionInfo.cs" />
        <Compile Include="DesktopModules\SolidCP\Code\Framework\ES.cs" Link="Code\ES.cs" />
        <Compile Include="Properties\AssemblyInfo.cs" />
        <Compile Update="Default.aspx.cs">
            <SubType>ASPXCodeBehind</SubType>
            <DependentUpon>Default.aspx</DependentUpon>
        </Compile>
        <Compile Update="Default.aspx.designer.cs">
            <DependentUpon>Default.aspx</DependentUpon>
        </Compile>
        <Compile Update="Global.asax.cs">
            <DependentUpon>Global.asax</DependentUpon>
        </Compile>
    </ItemGroup>
    <ItemGroup>
        <Content Include="Global.asax" />
        <Content Include="Default.aspx" />
        <Content Include="Web6.config">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="Web.config">
            <SubType>Designer</SubType>
        </Content>
    </ItemGroup>
    <ItemGroup>
        <Content Include="App_Browsers\CSSFriendlyAdapters.browser" />
        <Content Include="App_Data\*.config">
            <SubType>Designer</SubType>
        </Content>
        <Content Include="manifest.json" />
        <None Include="compilerconfig.json" />
        <None Include="compilerconfig.json.defaults">
            <DependentUpon>compilerconfig.json</DependentUpon>
        </None>
        <None Include="Properties\PublishProfiles\Default Settings.pubxml" />
        <EmbeddedResource Include="Code\Adapters\empty.gif" />
    </ItemGroup>
    <ItemGroup>
        <!--<ProjectReference Include="..\..\Lib\WebFormsForCore\src\WebFormsForCore.Web\WebFormsForCore.Web.csproj" />-->
        <ProjectReference Include="..\CPCC\CPCC.csproj" />
        <ProjectReference Include="..\SolidCP.EnterpriseServer.Base\SolidCP.EnterpriseServer.Base.csproj" />
        <ProjectReference Include="..\SolidCP.EnterpriseServer\WebServices\SolidCP.Build\SolidCP.EnterpriseServer.Client.csproj" />
        <ProjectReference Include="..\SolidCP.Providers.Base\SolidCP.Providers.Base.csproj" />
        <ProjectReference Include="..\SolidCP.Web.Clients\SolidCP.Web.Clients.csproj" />
        <ProjectReference Include="..\SolidCP.Web.Services\SolidCP.Web.Services.csproj" />
    </ItemGroup>
    <ItemGroup>
        <None Remove="obj\**\*.*" />
        <None Remove="bin_dotnet\**\*.*" />
        <None Remove="Properties\PublishProfiles\**" />
        <None Remove="appsettings.json" />
        <None Update="SolidCP.WebPortal.deps.json.old">
            <CopyToOutputDirectory>Never</CopyToOutputDirectory>
        </None>
        <AspNetControls Remove="DesktopModules\**\*.ascx" />
        <AspNetControls Remove="DesktopModules\**\*.aspx" />
        <AspNetControls Remove="DesktopModules\**\*.master" />
        <AspNetControls Remove="Properties\PublishProfiles\**" />
        <Compile Remove="Properties\PublishProfiles\**" />
        <Content Remove="Properties\PublishProfiles\**" />
    </ItemGroup>

    <Target Name="ChangeAliasesOfNugetRefs" Condition="$(TargetFramework) != 'net48'" BeforeTargets="FindReferenceAssembliesForReferences;ResolveReferences">
        <ItemGroup>
            <!-- Do not import System.Configuration.ConfigurationManager version 8 -->
            <ReferencePath Remove="%(Identity)" Condition="'%(FileName)' == 'System.Configuration.ConfigurationManager' AND $([System.Text.RegularExpressions.Regex]::IsMatch(%(Identity),'\\8\.0\..\\'))" />
            <!-- Do not import System.Web -->
            <ReferencePath Remove="%(Identity)" Condition="'%(FileName)' == 'System.Web' AND $([System.Text.RegularExpressions.Regex]::IsMatch(%(Identity),'\\dotnet\\'))" />
        </ItemGroup>
    </Target>

    <Target Name="CopyCoreWebConfig" AfterTargets="Build">
        <Copy SourceFiles="Core.Web.config" DestinationFiles="bin_dotnet\Web.config" />
        <Message Text="Copied Core.Web.config" Importance="high" />
    </Target>

    <Target Name="DeleteUnusedDlls" AfterTargets="Build">

        <!-- move lazy loaded assemblies to bin\Code and delete unused assemblies in bin -->
        <Message Text="Delete unused dll files" Importance="high" />
        <ItemGroup>
            <FilesToMove Include="bin\Microsoft.Bcl.*" />
            <FilesToMove Include="bin\Microsoft.Win32.Registry.*" />
            <FilesToMove Include="bin\Newtonsoft.Json.*" />
            <FilesToMove Include="bin\Microsoft.IdentityModel.*" />
            <FilesToMove Include="bin\Microsoft.Web.Administration.*" />
            <FilesToMove Include="bin\Microsoft.ReportViewer.*" />
            <FilesToMove Include="bin\Microsoft.Extensions.*" />
            <FilesToMove Include="bin\Microsoft.Web.*" />
            <FilesToMove Include="bin\SolidCP.Server.Client.*" />
            <FilesToMove Include="bin\MsieJavaScriptEngine.*" />
            <FilesToMove Include="bin\Renci.SshNet.*" />
            <FilesToMove Include="bin\SolidCP.EnterpriseServer.Client.*" />
            <FilesToMove Include="bin\SolidCP.Providers.*" Exclude="bin\SolidCP.Providers.Virtualization.NoVNC.*" />
            <FilesToMove Include="bin\WebGrease.*" />
            <FilesToMove Include="bin\JavaScriptEngineSwitcher.*" />
            <FilesToMove Include="bin\System.*" />
            <FilesToMove Include="bin\SwaggerWcf.*" />
            <FilesToMove Include="bin\SkiaSharp.*" />
            <FilesToMove Include="bin\BouncyCastle.*" />
            <FilesToMove Include="bin\Antlr3.*" />
            <FilesToMove Include="bin\AdvancedStringBuilder.*" />
            <FilesToMove Include="bin\AntiXssLibrary.*" />
            <FilesToMove Include="bin\HtmlSanitizationLibrary.*" />
            <FilesToDelete Include="bin\WebServices\**\*.*" />
            <FilesToDelete Include="bin_dotnet\WebServices\**\*.*" />
            <!--<FilesToDelete Include="bin\refs\**\*.*" />-->
        </ItemGroup>

        <Delete Files="@(FilesToDelete)" ContinueOnError="true" />
        <Move SourceFiles="@(FilesToMove)" DestinationFolder="bin\Lazy" ContinueOnError="true" />
        <RemoveDir Directories="bin\WebServices;bin\refs;bin_dotnet\WebServices" ContinueOnError="true" />
    </Target>

    <!--<Target Name="CopyDepsJson" Condition="$(TargetFramework) != 'net48'" AfterTargets="Build">
        
        <ItemGroup>
            <DepsJson Include="SolidCP.WebPortal.deps.json" />
        </ItemGroup>

        <Copy SourceFiles="@(DepsJson)" DestinationFolder="$(OutputPath)" />
    </Target>-->

</Project>