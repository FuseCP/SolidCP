// wcf service contract
@using Microsoft.CodeAnalysis
@using Microsoft.CodeAnalysis.CSharp
@using Microsoft.CodeAnalysis.CSharp.Syntax
@using System;
@using System.Collections.Generic;
@using System.Text;
@using System.Linq;

@using static Microsoft.CodeAnalysis.CSharp.SyntaxFactory

@namespace SolidCP.Build
@inherits RazorBlade.PlainTextTemplate

@Class.AttributeLists
[System.CodeDom.Compiler.GeneratedCodeAttribute("SolidCP.Build", "1.0")]
[ServiceContract(Namespace="@(WebServiceNamespace)")]
public interface I@(Class.Identifier) {

	@foreach (var method in WebMethods
		.Select(m => (MemberDeclarationSyntax)MethodDeclaration(m.ReturnType, m.Identifier)
					.WithAttributeLists(m.AttributeLists
						.Add(AttributeList(SingletonSeparatedList(Attribute(IdentifierName("OperationContract")))))
						.Add(AttributeList(SingletonSeparatedList(WebInvokeAttribute(m)))))
					.WithParameterList(m.ParameterList)
					.WithSemicolonToken(Token(SyntaxKind.SemicolonToken)))) {
		@method
	}

}

@functions
{
	public string WebServiceNamespace { get; set; }
	public ClassDeclarationSyntax Class { get; set; }
	public IEnumerable<MethodDeclarationSyntax> WebMethods { get; set; }
	public SemanticModel Model { get; set; }

	public bool IsSimpleType(TypeSyntax type)
	{
		if (type is NullableTypeSyntax) {
			var nullable = (NullableTypeSyntax)type;
			return IsSimpleType(nullable.ElementType);
		}

		var tm = Model.GetTypeInfo(type).Type as INamedTypeSymbol;
		var name = tm?.GetFullTypeName();
		return name != null && (name == typeof(byte).FullName || name == typeof(sbyte).FullName || name == typeof(char).FullName || name == typeof(string).FullName || name == typeof(short).FullName ||
			name == typeof(ushort).FullName || name == typeof(int).FullName || name == typeof(uint).FullName || name == typeof(long).FullName || name == typeof(ulong).FullName ||
			name == typeof(float).FullName || name == typeof(double).FullName);
	}

	public AttributeSyntax WebInvokeAttribute(MethodDeclarationSyntax method)
	{
		var name = method.Identifier.Text;
		string webMethod;
		if (name.StartsWith("Add", StringComparison.OrdinalIgnoreCase) ||
			name.StartsWith("Insert", StringComparison.OrdinalIgnoreCase) ||
			name.StartsWith("Create", StringComparison.OrdinalIgnoreCase)) webMethod = "PUT";
		else if (name.StartsWith("Update", StringComparison.OrdinalIgnoreCase) ||
			name.StartsWith("Set", StringComparison.OrdinalIgnoreCase)) webMethod = "POST";
		else if (name.StartsWith("Delete", StringComparison.OrdinalIgnoreCase) || 
			name.StartsWith("Remove", StringComparison.OrdinalIgnoreCase) ||
			name.StartsWith("Drop", StringComparison.OrdinalIgnoreCase)) webMethod = "DELETE";
		else webMethod = "GET";

		var parameters = method.ParameterList.Parameters
			.OfType<ParameterSyntax>()
			.Select(par => new {
				Parameter = par,
				IsSimple = !par.Modifiers.Any(mod => mod.IsKind(SyntaxKind.OutKeyword)) && IsSimpleType(par.Type)
			});
		IEnumerable<ParameterSyntax> simpleParameters = parameters
			.Where(par => par.IsSimple)
			.Select(par => par.Parameter);
		IEnumerable<ParameterSyntax> complexParameters = parameters
			.Where(par => !par.IsSimple)
			.Select(par => par.Parameter);
		var complexParametersCount = complexParameters.Count();
		var hasComplexParameters = complexParametersCount >= 1;
		var hasMultipleComplexParameters = complexParametersCount >= 2;
		if (hasComplexParameters) webMethod = "POST";
		var sb = new StringBuilder();

		sb.Append("/"); sb.Append(method.Identifier.Text);
		foreach (var par in simpleParameters)
		{
			sb.Append("/{"); sb.Append(par.Identifier.Text); sb.Append("}");
		}
		var uri = sb.ToString();

		var isGet = webMethod == "GET";
		AttributeSyntax attr;
		if (isGet) attr = Attribute(IdentifierName("WebGet"));
		else attr = Attribute(IdentifierName("WebInvoke"));
		attr = attr.WithArgumentList(ParseAttributeArgumentList((!isGet ? $"(Method = \"{webMethod}\", " : "(") + $"UriTemplate = \"{uri}\"" +
			(hasMultipleComplexParameters ? $", BodyStyle = WebMessageBodyStyle.WrappedRequest)" : ")")));
			//"RequestFormat = WebMessageFormat.Json, ResponseFormat = WebMessageFormat.Json)"
		return attr;
	}

}